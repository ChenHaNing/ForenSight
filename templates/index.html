<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>多智能体财务舞弊识别系统</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body data-has-key="{{ 'true' if has_api_key else 'false' }}">
  <div class="background">
    <div class="orb orb-one"></div>
    <div class="orb orb-two"></div>
    <div class="grid-overlay"></div>
  </div>

  <header class="top-bar">
    <div class="brand">
      <div class="logo">FFMAS</div>
      <div>
        <h1>多智能体财务舞弊识别系统</h1>
        <p>智能博弈 · 证据驱动 · 监管级呈现</p>
      </div>
    </div>
    <div class="status-pill" id="status-pill">就绪</div>
  </header>

  <main class="layout">
    <aside class="panel">
      <h2>运行配置</h2>
      <div class="form-group">
        <label>LLM Provider</label>
        <input id="provider" type="text" value="{{ defaults.provider }}" />
      </div>
      <div class="form-group">
        <label>LLM Model</label>
        <input id="model" type="text" value="{{ defaults.model }}" />
      </div>
      <div class="form-group">
        <label>LLM Base URL</label>
        <input id="base_url" type="text" value="{{ defaults.base_url }}" />
      </div>
      <div class="form-row">
        <label class="switch">
          <input id="enable_defense" type="checkbox" checked />
          <span class="slider"></span>
        </label>
        <span>启用辩护智能体</span>
      </div>
      <div class="form-row">
        <label class="switch">
          <input id="use_samples" type="checkbox" {% if has_samples %}checked{% endif %} />
          <span class="slider"></span>
        </label>
        <span>使用样本文档</span>
      </div>
      <button class="primary" id="run-btn">运行分析</button>
      <div class="hint">
        可使用输入文本或本地 PDF 进行分析。<br />
        API Key 从环境变量读取，不在前端显示。
      </div>
      {% if not has_api_key %}
      <div class="hint warning">未检测到 API Key，请在 .env 中配置 LLM_API_KEY。</div>
      {% endif %}
    </aside>

    <section class="content">
      <section class="hero">
        <div>
          <h2>多智能体对抗推理可视化</h2>
          <p>通过指控、辩护、裁决三段式推理，将舞弊风险收敛为可解释的监管级报告。</p>
        </div>
        <div class="hero-actions">
          <button class="ghost" id="download-final" disabled>下载最终报告</button>
          <button class="ghost" id="download-workpaper" disabled>下载工作底稿</button>
        </div>
      </section>

      <section class="workflow-grid">
        <div class="card workflow-canvas">
          <div class="workflow-head">
            <h3>Agent 工作流画布</h3>
            <p>按「汇聚 -> 识别 -> 指控 -> 辩护 -> 裁决」顺序流式传导</p>
          </div>
          <ul id="timeline" class="wf-steps">
            <li class="wf-node" data-step="collect">
              <span class="node-title">信息汇聚与结构化底稿</span>
              <span class="node-meta" id="node-meta-collect">等待中</span>
            </li>
            <li class="wf-node" data-step="base">
              <span class="node-title">基础风险识别</span>
              <span class="node-meta" id="node-meta-base">等待中</span>
            </li>
            <li class="wf-node" data-step="agents">
              <span class="node-title">指向型舞弊智能体</span>
              <span class="node-meta" id="node-meta-agents">等待中</span>
            </li>
            <li class="wf-node" data-step="defense">
              <span class="node-title">辩护分析智能体</span>
              <span class="node-meta" id="node-meta-defense">等待中</span>
            </li>
            <li class="wf-node" data-step="judge">
              <span class="node-title">裁决智能体输出</span>
              <span class="node-meta" id="node-meta-judge">等待中</span>
            </li>
          </ul>
          <div class="trace-bar" id="trace-bar">
            <span class="trace-segment" data-step="collect"></span>
            <span class="trace-segment" data-step="base"></span>
            <span class="trace-segment" data-step="agents"></span>
            <span class="trace-segment" data-step="defense"></span>
            <span class="trace-segment" data-step="judge"></span>
          </div>
        </div>

        <div class="card step-output workflow-output">
          <h3>步骤输出</h3>
          <div id="step-outputs" class="step-outputs">
            <details open data-step="collect">
              <summary>信息汇聚与结构化底稿</summary>
              <div class="step-body" id="collect-output">—</div>
              <div class="step-body" id="workpaper-output">—</div>
            </details>
            <details data-step="base">
              <summary>基础风险识别</summary>
              <div class="step-body" id="base-output">—</div>
            </details>
            <details data-step="agents">
              <summary>指向型舞弊智能体</summary>
              <div class="step-body" id="agent-output">—</div>
            </details>
            <details data-step="defense">
              <summary>辩护分析智能体</summary>
              <div class="step-body" id="defense-output">—</div>
            </details>
            <details data-step="judge">
              <summary>裁决智能体输出</summary>
              <div class="step-body" id="final-output">—</div>
            </details>
          </div>
        </div>

        <div class="card arena workflow-arena">
          <h3>多智能体对抗棋盘</h3>
          <div class="agents" id="agents">
            <div class="agent" data-agent="base" data-step-group="base">
              <h4>基础风险智能体</h4>
              <p class="status">等待中</p>
              <div class="body"></div>
            </div>
            <div class="agent" data-agent="fraud_type_A" data-step-group="agents">
              <h4>虚构交易类收入舞弊</h4>
              <p class="status">等待中</p>
              <div class="body"></div>
            </div>
            <div class="agent" data-agent="fraud_type_B" data-step-group="agents">
              <h4>净利润操纵舞弊</h4>
              <p class="status">等待中</p>
              <div class="body"></div>
            </div>
            <div class="agent" data-agent="fraud_type_C" data-step-group="agents">
              <h4>会计操纵收入舞弊</h4>
              <p class="status">等待中</p>
              <div class="body"></div>
            </div>
            <div class="agent" data-agent="fraud_type_D" data-step-group="agents">
              <h4>净资产舞弊</h4>
              <p class="status">等待中</p>
              <div class="body"></div>
            </div>
            <div class="agent" data-agent="fraud_type_E" data-step-group="agents">
              <h4>资金占用舞弊</h4>
              <p class="status">等待中</p>
              <div class="body"></div>
            </div>
            <div class="agent" data-agent="fraud_type_F" data-step-group="agents">
              <h4>特殊行业/业务模式</h4>
              <p class="status">等待中</p>
              <div class="body"></div>
            </div>
            <div class="agent" data-agent="defense" data-step-group="defense">
              <h4>辩护分析智能体</h4>
              <p class="status">等待中</p>
              <div class="body"></div>
            </div>
            <div class="agent highlight" data-agent="judge" data-step-group="judge">
              <h4>裁决智能体</h4>
              <p class="status">等待中</p>
              <div class="body"></div>
            </div>
          </div>
        </div>
      </section>

      <section class="grid">
        <div class="card report">
          <h3>综合裁决报告</h3>
          <div class="report-grid">
            <div>
              <p class="label">总体风险等级</p>
              <p class="value" id="risk-level">—</p>
            </div>
            <div>
              <p class="label">接受的风险点</p>
              <ul id="accepted-points"></ul>
            </div>
            <div>
              <p class="label">驳回的风险点</p>
              <ul id="rejected-points"></ul>
            </div>
            <div>
              <p class="label">监管建议</p>
              <ul id="suggestions"></ul>
            </div>
          </div>
          <div class="report-note">
            <p><strong>裁决依据</strong></p>
            <p id="rationale">—</p>
            <p class="muted" id="uncertainty">—</p>
          </div>
        </div>
        <div class="card evidence">
          <h3>证据链摘要</h3>
          <div id="evidence-list" class="evidence-list"></div>
        </div>
        <div class="card evidence">
          <h3>外部检索摘要</h3>
          <div id="external-search" class="evidence-list"></div>
        </div>
      </section>
    </section>
  </main>

  <script src="/static/app.js"></script>
</body>
</html>
